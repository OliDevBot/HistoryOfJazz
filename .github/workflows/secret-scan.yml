name: Secret Scan

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for blocked files
        run: |
          BLOCKED="\.env$|MEMORY\.md$|USER\.md$|SOUL\.md$|IDENTITY\.md$|AGENTS\.md$|TOOLS\.md$|HEARTBEAT\.md$|openclaw\.json$"
          FOUND=$(git ls-files | grep -E "$BLOCKED" || true)
          if [ -n "$FOUND" ]; then
            echo "❌ Blocked files found in repository:"
            echo "$FOUND"
            exit 1
          fi
          echo "✅ No blocked files found."

      - name: Scan for secret patterns
        run: |
          PATTERNS='ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|ghu_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9_]{82}|sk-[a-zA-Z0-9]{20,}|GITHUB_PAT=[a-zA-Z0-9]|NOTION_API_KEY=[a-zA-Z0-9]|BOT_TOKEN=[0-9]|BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY'
          # Scan all tracked files (excluding this workflow itself)
          FOUND=$(git ls-files | grep -v '.github/workflows/secret-scan.yml' | xargs grep -rlE "$PATTERNS" 2>/dev/null || true)
          if [ -n "$FOUND" ]; then
            echo "❌ Potential secrets found in:"
            echo "$FOUND"
            # Show matches (redacted)
            for f in $FOUND; do
              echo "--- $f ---"
              grep -nE "$PATTERNS" "$f" | sed 's/\(.\{40\}\).*/\1...REDACTED/'
            done
            exit 1
          fi
          echo "✅ No secrets detected."
